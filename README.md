## 1. Aave V3 / Compound V3 协议的优势以及两个协议的设计上的区别在哪里?

### Aave V3 优势

1. Portal: 支持跨链桥，用户可以通过跨链桥在不同区块链之间转移资产，提供流动性和借贷
2. eMode: 当供应和借出的资产具有价格相关性时，特别是同意标的的资产时，eMode 允许借款人从抵押物中获取更高的借贷能力
3. Isolation Mode: 新列出的资产会被标记为隔离资产。提供隔离资产作为抵押物的借款人不能提供其他资产作为抵押品。同时只能借出由 Aave governance 配置的稳定币，并且有债务上限限制
4. Siloed Borrowing: 对于潜在可操纵预言机的资产，只能作为单一抵押物来借贷。降低协议的潜在风险
5. Supply and Borrow Caps: Aave governance 可以配置借款和供应的上限
   1. 借款上限：允许调整每项资产的借出金额，降低破产风险
   2. 供应上限：允许限制向 Aave 供应某种资产的数量。减少潜在攻击带来的风险，如价格预言机攻击
6. Granular Borrowing Power Control: 可以将任何的资产的借贷能力降低至 0，而且不会对现有借款人产生影响，如果有必要，可以清算现有用户
7. Risk Admins: 通过 Aave governance，可授予实体更新风险参数的权限，并对每次更改进行投票。实体可以是 DAO 或自动化代理，以便在意外事件发生时自动做出反应
8. Price Oracle Sentinel: 引入了清算宽限期，并在特定情况下禁止借贷，专为 L2 设计
9. Variable Liquidation Close Factor: 允许仓位在接近破产时被完全强平，即 HF < 0.95 (旧版本任何时候只能强平一半仓位)
10. gas 优化: Aave V3 所有相关功能的 gas 都进行了优化，gas 全面降低了约 20 ～ 25%
11. 利率策略: 在资金池达到最佳使用率之前，利率保持相对较慢的速度线性增加；超过最佳使用率之后，利率增速陡增，会飞速线性上涨

### Compound V3 优势

1. 单一资产借贷: 贷款人可以通过提供单一资产来获取收益，借款人可以提供多种资产来作为抵押品，借出单一资产
2. 双重抵押品系数: 借款抵押品系数 LCF，清算抵押品系数 BCF，LCF > BCF。只有当用户借出资金累计到足够高，达到清算抵押品系数时，才可以被清算。
3. 供应上限: Compound V3 governance 可以在每个市场中设置最大供应量。减轻市场中特定抵押资产的风险
4. 清算机制改动: 清算过程分为 1）从协议的储备金中偿还被清算的头寸，同时将抵扣的抵押品保留在储备金中；2）一旦储备金中特定资产达到阈值，启动清算。
5. 预言机优化：协议可以从多个预言机数据源中获取信息，并对其进行核验，避免单一预言机数据源故障对协议造成冲击，同时可以交叉对比验证，确保价格数据的准确性和及时性。Aave V3 也提供了类似的能力，具有更高的可靠性和抗攻击性

### Aave V3 和 Compound V3 区别

1. 跨链功能：Aave V3 支持，Compound V3 暂不支持
2. 借贷模式：Aave V3 支持用户基础多种资产，并用 eMode 提高相同类型资产之间的借贷效率；Compound V3 则是单资产借贷模式，用户只能存入单一资产，简化了借贷流程，减少清算复杂性，同时也限制了多资产借贷带来的灵活性
3. 风险管理：Aave V3 才用了孤立模式和自适应风险系数，灵活地处理高风险或新添加的资产，降低了潜在的协议风险；Compound V3 通过简化的借贷模型和改进的清算机制，优化了协议的安全。重点是降低清算风险，单在资产风险管理的灵活性上不如 Aave V3
4. 代币经济学：Aave V3 使用 AAVE 代币进行治理，并有流动性挖矿激励；Compound V3 保持使用 COMP 代币进行治理，但是不在提供激励
5. 清算机制：Compound V3 优化了清算机制，加入了缓冲步骤，可以减少潜在的预言机攻击带来的清算风险

#### 总结

Aave 在跨链操作、资本利用率和灵活性上更具优势，适合需要高流动性和多资产借贷的用户；Compound V3 则是简化了借贷模型，更强调高效、安全，适合寻求低风险和简单借贷的用户。

## 2. 假设需要与某个 DeFi 协议(如 aave)进行交互，例如获取用户的仓位信息，如何分析和理解该协议？

1. 查看 Aave 官方文档和智能合约代码

通过[官方文档](https://docs.aave.com/developers)，了解协议架构、核心组件、如何调用协议的智能合约和 API 等。

通过[Etherscan, 这里是 aave pool 代码](https://etherscan.io/address/0x87870Bca3F3fD6335C3F4ce8392D69350B4fA4E2#code)和[Github](https://github.com/aave-dao/aave-v3-origin)，获取协议的智能合约代码，更加深入的了解核心模块的实现

2. 理解协议核心函数

获取 Aave 协议下用户的仓位信息，可以考虑通过 aave pool 合约的关键函数：

- `getUserAccountData`：查询指定用户的抵押总额、借款总额、清算阈值等信息
- `getReserveData`：查询某一资产当前的流动性、借贷利率等数据

3. 可以利用 Dune 或其他链上数据分析工具，对协议进行更复杂的数据分析，如过去 24h 资产借款、抵押的变化，统计某用户的借款、抵押变化等等

## 3. 假设需要从 Uniswap V2 / V3 中获取流动性池的信息，你会如何理解和解析这个协议的接口？

整体步骤[##2]类似，这里以 Uniswap V2 为例，具体介绍下通过 Etherscan 获取 Uni/USDT 的流动性池的步骤：

1. 通过[Uniswap V2 官方文档](https://docs.uniswap.org/contracts/v2/reference/smart-contracts/factory#address)获取 `UniswapV2Factory` 部署在 Ethereum mainnet 的合约地址为 `0x5C69bEe701ef814a2B6a3EDD4B1652CB9cc5aA6f`
2. 通过 Etherscan 查询 UNI 和 USDT 的 ERC20 合约地址，分别为 `0x1f9840a85d5aF5bf1D1762F925BDADdC4201F984`, `0xdAC17F958D2ee523a2206206994597C13D831ec7`
3. 通过 `UniswapV2Factory` 的 `getPair` 方法获取到 UNI 和 USDT 对应的币对合约地址为 `0x5ac13261c181a9c3938BfE1b649E65D10F98566B`
4. 在币对合约下，通过 `getReserves`, `totalSupply` 等方法查询 UNI/USDT 的流动性池状态

## 4.找一个熟悉的协议，说说理解

Uniswap V2

特点：

1. 自动做市商模型（AMM）：恒定乘积公式 xy = k，x 和 y 分别是流动性池中两种代币的数量，k 是恒定常数。用户通过与流动性池直接交换代币，而流动性池中的代币根据公式计算进行调整。实现无限流动性，即价格范围区间：[0, +∞]
2. 相比于 V1 的币对其中一个必须为 ETH，V2 的币对代币可以是任何符合 ERC20 协议的 Token
3. 流动性提供者（LP）：用户可以向流动性池中添加两种等价值的代币，从而成为该币对的流动性提供者。作为回报/证明，流动性提供者会收到对应币对的 LP 代币，代表他们在流动性池中的份额。而每笔交易都收取 0.3%的手续费，这个费用全部由流动性提供者所有
4. 无许可性：任何地址均可创建新的币对并向其中添加流动性
5. 币对与流动性池：通过 factory 合约，为每个不同的币对生产一个单独的智能合约，用于管理该币对的所有交易和流动性操作

主要合约：

1. Factory 合约：用于创建和管理所有的币对
2. Pair 合约：每个交易对都有一个对应的 Pair 合约，它持有两种代币的储备，并提供流动性，支持代币的自由兑换
3. Router 合约：提供用户交互友好的接口合约，如添加流动性，移除流动性，交易代币均通过 router 合约，router 合约再找到底层的 Factory 或 Pair 合约进行交互

优点：

1. 由于 xy=k 的恒定乘积公式，Uniswap 交易币对不在像传统的 Exchange 一样需要用户手动挂单这种方式运行
2. 由于其无许可性的特点，任何人都可提供任意的 ERC20 Token 流动性，因此 Uniswap 提供了丰富的可供交易的币对和深厚的流动性
3. 由于区块链和智能合约的特点，交易者不需依赖或信任任何中介，所有操作均通过智能合约执行

局限性：

1. 流动性提供者可能面对无常损失的风险，即币对价格的波动导致流动性提供者的代币价值相对减少
2. 由于 xy=k 带来的无限价格区间，而流动池提供的流动性通常是有限的，因此对于大额交易，可能会导致币对的价格发生大幅波动，即滑点
